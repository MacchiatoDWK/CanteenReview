<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商家管理系统</title>
    <!-- 引入Bootstrap CSS -->
    <link href="https://cdn.staticfile.org/twitter-bootstrap/5.2.3/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入Font Awesome图标 -->
    <link href="https://cdn.staticfile.org/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- 引入Chart.js -->
    <script src="https://cdn.staticfile.org/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }
        .navbar {
            background-color: #343a40;
        }
        .sidebar {
            min-height: calc(100vh - 56px);
            background-color: #343a40;
            color: white;
        }
        .sidebar a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
        }
        .sidebar a:hover {
            color: white;
        }
        .sidebar .active {
            background-color: #495057;
            color: white;
        }
        .content {
            padding: 20px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .rating {
            color: #ffc107;
        }
        .comment-item {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
        }
        .comment-item:last-child {
            border-bottom: none;
        }
        .comment-image {
            max-width: 100px;
            max-height: 100px;
            margin-right: 5px;
            cursor: pointer;
        }
        .modal-image {
            max-width: 100%;
        }
        .badge {
            margin-right: 5px;
        }
        .sort-btn {
            margin-right: 5px;
        }
        #reportChart {
            max-height: 300px;
        }
        .keyword-cloud {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .keyword-item {
            padding: 5px 10px;
            background-color: #e9ecef;
            border-radius: 15px;
            font-size: 14px;
        }
        .loading {
            display: flex;
            justify-content: center;
            padding: 20px;
        }
        .stall-info {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }
        .auth-message {
            text-align: center;
            padding: 40px 20px;
        }
        .auth-message i {
            font-size: 48px;
            margin-bottom: 20px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">食堂评价系统 - 商家管理</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">返回首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="mine.html">个人中心</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主内容区 -->
    <div class="container-fluid">
        <!-- 加载状态 -->
        <div id="loading-container" class="row justify-content-center mt-5">
            <div class="col-md-8 text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-3">正在加载商家信息...</p>
            </div>
        </div>

        <!-- 未认证或未绑定档口的提示 -->
        <div id="no-stall-container" class="row justify-content-center mt-5 d-none">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body auth-message">
                        <i class="fas fa-store-slash"></i>
                        <h3 id="no-stall-title">您尚未绑定档口</h3>
                        <p id="no-stall-message" class="text-muted">请先完成档口认证申请</p>
                        <a href="auth.html" class="btn btn-primary mt-3">
                            <i class="fas fa-user-check me-2"></i>申请认证
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 已认证商家的管理界面 -->
        <div id="merchant-container" class="row d-none">
            <!-- 侧边栏 -->
            <div class="col-md-2 sidebar p-0">
                <div class="list-group list-group-flush">
                    <a href="#" class="list-group-item list-group-item-action active bg-dark text-white" id="reviews-tab">
                        <i class="fas fa-comment me-2"></i>评论管理
                    </a>
                    <a href="#" class="list-group-item list-group-item-action bg-dark text-white" id="reports-tab">
                        <i class="fas fa-chart-line me-2"></i>周报管理
                    </a>
                </div>
            </div>

            <!-- 主内容区 -->
            <div class="col-md-10 content">
                <!-- 档口信息 -->
                <div class="stall-info mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <h5><i class="fas fa-store me-2"></i>当前档口</h5>
                            <p class="mb-1"><strong>食堂：</strong><span id="current-canteen"></span></p>
                            <p class="mb-0"><strong>档口：</strong><span id="current-stall"></span></p>
                        </div>
                    </div>
                </div>

                <!-- 评论管理页面 -->
                <div id="reviews-section">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">评论列表</h5>
                            <div>
                                <button class="btn btn-sm btn-outline-primary sort-btn" data-sort="-Timestamp">
                                    <i class="fas fa-clock"></i> 最新
                                </button>
                                <button class="btn btn-sm btn-outline-primary sort-btn" data-sort="rating_high">
                                    <i class="fas fa-sort-amount-up"></i> 评分从高到低
                                </button>
                                <button class="btn btn-sm btn-outline-primary sort-btn" data-sort="rating_low">
                                    <i class="fas fa-sort-amount-down"></i> 评分从低到高
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="comments-container">
                                <!-- 评论内容将通过JavaScript动态加载 -->
                            </div>
                            <div id="loading-comments" class="loading">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <button id="load-more" class="btn btn-primary d-none">加载更多</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 周报管理页面 -->
                <div id="reports-section" class="d-none">
                    <div class="row">
                        <div class="col-md-12 mb-4">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">周报统计</h5>
                                    <div>
                                        <div class="btn-group me-2" role="group">
                                            <button type="button" class="btn btn-outline-secondary period-btn" data-days="7">7天</button>
                                            <button type="button" class="btn btn-outline-secondary period-btn" data-days="14">14天</button>
                                            <button type="button" class="btn btn-outline-secondary period-btn" data-days="30">30天</button>
                                            <button type="button" class="btn btn-outline-secondary period-btn" data-days="0">全部</button>
                                        </div>
                                        <button id="generate-report" class="btn btn-primary">
                                            <i class="fas fa-file-alt me-2"></i>生成周报
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="report-loading" class="loading d-none">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">生成中...</span>
                                        </div>
                                    </div>
                                    <div id="report-content" class="d-none">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="card mb-3">
                                                    <div class="card-body">
                                                        <h6 class="card-title">基本信息</h6>
                                                        <table class="table table-sm">
                                                            <tbody>
                                                                <tr>
                                                                    <th>食堂名称</th>
                                                                    <td id="report-canteen"></td>
                                                                </tr>
                                                                <tr>
                                                                    <th>档口名称</th>
                                                                    <td id="report-stall"></td>
                                                                </tr>
                                                                <tr>
                                                                    <th>统计周期</th>
                                                                    <td id="report-period"></td>
                                                                </tr>
                                                                <tr>
                                                                    <th>总评论数</th>
                                                                    <td id="report-total"></td>
                                                                </tr>
                                                                <tr>
                                                                    <th>平均评分</th>
                                                                    <td id="report-avg"></td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card mb-3">
                                                    <div class="card-body">
                                                        <h6 class="card-title">评分分布</h6>
                                                        <div id="reportChartContainer" style="height: 300px;">
                                                            <canvas id="reportChart" width="400" height="300"></canvas>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="card mb-3">
                                                    <div class="card-body">
                                                        <h6 class="card-title">详细评分分布</h6>
                                                        <div id="detailedRatingChartContainer" style="height: 300px;">
                                                            <canvas id="detailedRatingChart" width="400" height="300"></canvas>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="card mb-3">
                                                    <div class="card-body">
                                                        <h6 class="card-title">常见关键词</h6>
                                                        <div id="keywords-container" class="keyword-cloud"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="report-error" class="alert alert-warning d-none"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">历史周报</h5>
                                </div>
                                <div class="card-body">
                                    <div id="history-loading" class="loading">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">加载中...</span>
                                        </div>
                                    </div>
                                    <div id="history-content" class="d-none">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>统计周期</th>
                                                    <th>评论数</th>
                                                    <th>平均评分</th>
                                                    <th>生成时间</th>
                                                    <th>操作</th>
                                                </tr>
                                            </thead>
                                            <tbody id="history-table">
                                                <!-- 历史周报将通过JavaScript动态加载 -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div id="history-empty" class="alert alert-info d-none">
                                        暂无历史周报数据
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 图片查看模态框 -->
    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">查看图片</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" class="modal-image" src="" alt="评论图片">
                </div>
            </div>
        </div>
    </div>

    <!-- 引入Bootstrap和jQuery JS -->
    <script src="https://cdn.staticfile.org/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/5.2.3/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局变量
        let currentPage = 1;
        let hasNextPage = false;
        let currentSort = '-Timestamp';
        let reportChart = null;
        let detailedRatingChart = null;
        let currentStall = null;
        let selectedDays = 7; // 默认7天
        let chartInstances = {}; // 存储所有图表实例的对象

        // 页面加载完成后执行
        $(document).ready(function() {
            // 检查用户登录状态和身份
            checkUserStatus();
            
            // 获取商家档口信息
            getMerchantStalls();
            
            // 绑定事件处理程序
            bindEvents();
        });

        // 检查用户登录状态和身份
        function checkUserStatus() {
            // 从cookie中获取用户信息
            const userid = getCookie('userid');
            const userType = getCookie('usertype');
            
            // 如果用户未登录或不是商家，则跳转到首页
            if (!userid || !userType) {
                window.location.href = 'index.html';
                return;
            }
            
            if (userType !== '2') {
                window.location.href = 'index.html';
                return;
            }
        }

        // 获取商家档口信息
        function getMerchantStalls() {
            $.ajax({
                url: '/get_merchant_stalls/',
                type: 'GET',
                success: function(response) {
                    $('#loading-container').addClass('d-none');
                    
                    if (response.success && response.has_stall) {
                        // 显示商家管理界面
                        $('#merchant-container').removeClass('d-none');
                        
                        // 保存当前档口信息
                        currentStall = response.stall;
                        
                        // 显示档口信息
                        $('#current-canteen').text(currentStall.canteen_name);
                        $('#current-stall').text(currentStall.name);
                        
                        // 加载评论数据
                        loadComments(currentPage, currentSort);
                        
                        // 加载历史周报数据
                        loadReportHistory();
                    } else {
                        // 显示未认证或未绑定档口的提示
                        $('#no-stall-container').removeClass('d-none');
                        
                        if (response.pending_auth) {
                            $('#no-stall-title').text('档口认证审核中');
                            $('#no-stall-message').text('您的档口认证申请正在审核中，请耐心等待');
                        } else {
                            $('#no-stall-title').text('您尚未绑定档口');
                            $('#no-stall-message').text(response.msg || '请先完成档口认证申请');
                        }
                    }
                },
                error: function(xhr, status, error) {
                    $('#loading-container').addClass('d-none');
                    
                    // 显示错误信息
                    $('#no-stall-container').removeClass('d-none');
                    $('#no-stall-title').text('加载失败');
                    $('#no-stall-message').text('获取商家信息失败，请刷新页面重试');
                }
            });
        }

        // 绑定事件处理程序
        function bindEvents() {
            // 切换标签页
            $('#reviews-tab').click(function(e) {
                e.preventDefault();
                $(this).addClass('active');
                $('#reports-tab').removeClass('active');
                $('#reviews-section').removeClass('d-none');
                $('#reports-section').addClass('d-none');
                
                // 彻底清理所有图表，避免内存泄漏
                cleanupAllCharts();
                
                // 重置图表容器
                $('#reportChartContainer').html('<canvas id="reportChart" width="400" height="300"></canvas>');
                $('#detailedRatingChartContainer').html('<canvas id="detailedRatingChart" width="400" height="300"></canvas>');
            });
            
            $('#reports-tab').click(function(e) {
                e.preventDefault();
                $(this).addClass('active');
                $('#reviews-tab').removeClass('active');
                $('#reports-section').removeClass('d-none');
                $('#reviews-section').addClass('d-none');
                
                // 如果从评论页面切换到周报页面，可能需要重新加载图表
                if (chartInstances['reportChart'] || chartInstances['detailedRatingChart']) {
                    cleanupAllCharts();
                }
            });
            
            // 排序按钮点击事件
            $('.sort-btn').click(function() {
                const sortBy = $(this).data('sort');
                currentSort = sortBy;
                currentPage = 1;
                loadComments(currentPage, sortBy);
                
                // 更新按钮样式
                $('.sort-btn').removeClass('btn-primary').addClass('btn-outline-primary');
                $(this).removeClass('btn-outline-primary').addClass('btn-primary');
            });
            
            // 加载更多按钮点击事件
            $('#load-more').click(function() {
                currentPage++;
                loadComments(currentPage, currentSort, true);
            });
            
            // 时间周期选择按钮点击事件
            $('.period-btn').click(function() {
                // 更新选中状态
                $('.period-btn').removeClass('btn-secondary').addClass('btn-outline-secondary');
                $(this).removeClass('btn-outline-secondary').addClass('btn-secondary');
                
                // 保存选择的天数
                selectedDays = $(this).data('days');
            });
            
            // 默认选中7天
            $('.period-btn[data-days="7"]').removeClass('btn-outline-secondary').addClass('btn-secondary');
            
            // 生成周报按钮点击事件
            $('#generate-report').click(function() {
                generateWeeklyReport(selectedDays);
            });
            
            // 图片点击事件（委托到父元素）
            $(document).on('click', '.comment-image', function() {
                const imgSrc = $(this).attr('src');
                $('#modalImage').attr('src', imgSrc);
                const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
                imageModal.show();
            });
        }

        // 加载评论数据
        function loadComments(page, sortBy, append = false) {
            $('#loading-comments').removeClass('d-none');
            $('#load-more').addClass('d-none');
            
            $.ajax({
                url: '/get_stall_reviews/',
                type: 'GET',
                data: {
                    page: page,
                    sort_by: sortBy
                },
                success: function(response) {
                    $('#loading-comments').addClass('d-none');
                    
                    if (response.success) {
                        // 显示评论数据
                        if (!append) {
                            $('#comments-container').empty();
                        }
                        
                        if (response.comments.length === 0 && page === 1) {
                            $('#comments-container').html('<div class="alert alert-info">暂无评论数据</div>');
                        } else {
                            // 添加评论到容器
                            response.comments.forEach(function(comment) {
                                const commentHtml = createCommentHtml(comment);
                                $('#comments-container').append(commentHtml);
                            });
                            
                            // 更新分页状态
                            hasNextPage = response.has_next;
                            if (hasNextPage) {
                                $('#load-more').removeClass('d-none');
                            } else {
                                $('#load-more').addClass('d-none');
                            }
                        }
                    } else {
                        // 显示错误信息
                        if (!append) {
                            $('#comments-container').html(`<div class="alert alert-danger">${response.msg || '加载评论失败'}</div>`);
                        }
                    }
                },
                error: function() {
                    $('#loading-comments').addClass('d-none');
                    if (!append) {
                        $('#comments-container').html('<div class="alert alert-danger">网络错误，请稍后重试</div>');
                    }
                }
            });
        }

        // 创建评论HTML
        function createCommentHtml(comment) {
            // 生成星级评分HTML
            let ratingHtml = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= comment.rating) {
                    ratingHtml += '<i class="fas fa-star rating"></i>';
                } else {
                    ratingHtml += '<i class="far fa-star rating"></i>';
                }
            }
            
            // 生成图片HTML
            let imagesHtml = '';
            if (comment.images && comment.images.length > 0) {
                imagesHtml = '<div class="mt-2">';
                comment.images.forEach(function(imgUrl) {
                    imagesHtml += `<img src="${imgUrl}" class="comment-image" alt="评论图片">`;
                });
                imagesHtml += '</div>';
            }
            
            // 生成评论类型标签
            let typeBadge = '';
            if (comment.objTypeName) {
                let badgeClass = comment.objType === 2 ? 'bg-primary' : 'bg-success';
                typeBadge = `<span class="badge ${badgeClass} me-2">${comment.objTypeName}</span>`;
                
                if (comment.objName) {
                    typeBadge += `<span class="badge bg-secondary">${comment.objName}</span>`;
                }
            }
            
            // 返回完整的评论HTML
            return `
                <div class="comment-item">
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>${comment.username}</strong>
                            <span class="ms-2">${ratingHtml}</span>
                        </div>
                        <small class="text-muted">${comment.timestamp}</small>
                    </div>
                    <div class="mt-1">
                        ${typeBadge}
                    </div>
                    <p class="mt-2">${comment.text}</p>
                    ${imagesHtml}
                </div>
            `;
        }

        // 清理所有图表和相关DOM元素
        function cleanupAllCharts() {
            // 销毁所有图表实例
            Object.keys(chartInstances).forEach(chartId => {
                if (chartInstances[chartId]) {
                    chartInstances[chartId].destroy();
                    chartInstances[chartId] = null;
                }
            });
            
            // 清空图表容器
            chartInstances = {};
            
            // 重新创建canvas元素
            $('#reportChartContainer').html('<canvas id="reportChart" width="400" height="300"></canvas>');
            $('#detailedRatingChartContainer').html('<canvas id="detailedRatingChart" width="400" height="300"></canvas>');
            
            // 移除所有图表相关的调试信息
            $('.chart-debug-info').remove();
        }
        
        // 生成周报
        function generateWeeklyReport(days = 7) {
            // 显示加载状态
            $('#report-loading').removeClass('d-none');
            $('#report-content').addClass('d-none');
            $('#report-error').addClass('d-none');
            
            // 彻底清理所有图表
            cleanupAllCharts();
            
            $.ajax({
                url: '/generate_weekly_report/',
                type: 'GET',
                data: {
                    days: days
                },
                timeout: 30000, // 30秒超时
                success: function(response) {
                    $('#report-loading').addClass('d-none');
                    
                    if (response.success) {
                        // 显示周报数据
                        displayWeeklyReport(response.report);
                        // 刷新历史周报列表
                        loadReportHistory();
                    } else {
                        // 显示错误信息
                        $('#report-error').removeClass('d-none').text(response.msg || '生成周报失败');
                    }
                },
                error: function(xhr, status, error) {
                    $('#report-loading').addClass('d-none');
                    
                    $('#report-error').removeClass('d-none').text('网络错误，请稍后重试');
                }
            });
        }

        // 显示周报数据
        function displayWeeklyReport(report) {
            // 彻底清理所有图表
            cleanupAllCharts();
            
            // 显示报告内容区域
            $('#report-content').removeClass('d-none');
            
            // 填充基本信息
            $('#report-canteen').text(report.canteen_name || '未知食堂');
            $('#report-stall').text(report.stall_name || '未知档口');
            $('#report-period').text(`${report.start_date || '-'} 至 ${report.end_date || '-'}`);
            
            // 确保数值为数字
            const totalReviews = parseInt(report.total_reviews) || 0;
            const avgRating = parseFloat(report.average_rating) || 0;
            
            $('#report-total').text(totalReviews);
            $('#report-avg').text(`${avgRating.toFixed(1)} / 5`);
            
            // 显示评分分布图表
            createRatingChart(report);
            
            // 显示详细评分分布图表
            createDetailedRatingChart(report);
            
            // 显示关键词
            displayKeywords(report.common_keywords);
        }

        // 创建评分分布图表（饼图）
        function createRatingChart(report) {
            // 确保评论总数为数字
            const totalReviews = parseInt(report.total_reviews) || 0;
            
            if (totalReviews === 0) {
                // 如果没有评论，显示提示信息
                $('#reportChartContainer').html('<div class="alert alert-info">暂无评论数据，无法生成评分分布图表</div>');
                return;
            }
            
            // 确保各评分数量为数字
            const highRating = parseInt(report.high_rating_count) || 0;
            const midRating = parseInt(report.mid_rating_count) || 0;
            const lowRating = parseInt(report.low_rating_count) || 0;
            
            // 创建新图表
            const ctx = document.getElementById('reportChart').getContext('2d');
            chartInstances['reportChart'] = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['好评 (4-5分)', '中评 (2-3分)', '差评 (0-1分)'],
                    datasets: [{
                        data: [highRating, midRating, lowRating],
                        backgroundColor: [
                            '#28a745',
                            '#ffc107',
                            '#dc3545'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = totalReviews || 1;
                                    const value = context.raw;
                                    const percentage = Math.round((value / total) * 100);
                                    return `${value}人 (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 创建详细评分分布图表（柱状图）
        function createDetailedRatingChart(report) {
            // 如果没有评分数据，隐藏图表
            if (!report.rating_counts || !report.total_reviews || parseInt(report.total_reviews) === 0) {
                $('#detailedRatingChartContainer').html('<div class="alert alert-info">暂无评论数据，无法生成详细评分分布图表</div>');
                return;
            }
            
            // 准备数据
            const labels = Object.keys(report.rating_counts).reverse(); // 从5分到1分排序
            const data = labels.map(label => {
                const value = parseInt(report.rating_counts[label]) || 0;
                return value;
            });
            const percentages = labels.map(label => {
                const value = parseFloat(report.rating_percentages[label]) || 0;
                return value;
            });
            
            // 创建图表
            const ctx = document.getElementById('detailedRatingChart').getContext('2d');
            chartInstances['detailedRatingChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '评分分布',
                        data: data,
                        backgroundColor: [
                            '#28a745', // 5分
                            '#5cb85c', // 4分
                            '#ffc107', // 3分
                            '#f0ad4e', // 2分
                            '#dc3545'  // 1分
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '评论数量'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const percentage = percentages[context.dataIndex];
                                    return `${value}人 (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 显示关键词
        function displayKeywords(keywords) {
            const container = $('#keywords-container');
            container.empty();
            
            // 如果没有关键词
            if (!keywords || Object.keys(keywords).length === 0) {
                container.html('<p class="text-muted">暂无关键词数据</p>');
                return;
            }
            
            // 显示关键词
            Object.entries(keywords).forEach(([word, count]) => {
                container.append(`<span class="keyword-item">${word} (${count})</span>`);
            });
        }

        // 加载历史周报
        function loadReportHistory() {
            $('#history-loading').removeClass('d-none');
            $('#history-content').addClass('d-none');
            $('#history-empty').addClass('d-none');
            
            $.ajax({
                url: '/get_report_history/',
                type: 'GET',
                success: function(response) {
                    $('#history-loading').addClass('d-none');
                    
                    if (response.success) {
                        if (response.reports.length === 0) {
                            // 没有历史数据
                            $('#history-empty').removeClass('d-none');
                        } else {
                            // 显示历史数据
                            $('#history-content').removeClass('d-none');
                            displayHistoryReports(response.reports);
                        }
                    } else {
                        // 显示错误信息
                        $('#history-empty').removeClass('d-none').text(response.msg || '加载历史周报失败');
                    }
                },
                error: function() {
                    $('#history-loading').addClass('d-none');
                    $('#history-empty').removeClass('d-none').text('网络错误，请稍后重试');
                }
            });
        }

        // 显示历史周报
        function displayHistoryReports(reports) {
            const tableBody = $('#history-table');
            tableBody.empty();
            
            reports.forEach(function(report) {
                tableBody.append(`
                    <tr>
                        <td>${report.start_date} 至 ${report.end_date}</td>
                        <td>${report.total_reviews}</td>
                        <td>${report.average_rating} / 5</td>
                        <td>${report.created_at}</td>
                        <td>
                            <button class="btn btn-sm btn-primary view-report-btn" data-report-id="${report.id}">
                                查看详情
                            </button>
                        </td>
                    </tr>
                `);
            });
            
            // 绑定查看详情按钮点击事件
            $('.view-report-btn').click(function() {
                const reportId = $(this).data('report-id');
                loadReportDetail(reportId);
            });
        }
        
        // 加载周报详情
        function loadReportDetail(reportId) {
            // 显示加载状态
            $('#report-loading').removeClass('d-none');
            $('#report-content').addClass('d-none');
            $('#report-error').addClass('d-none');
            
            // 彻底清理所有图表
            cleanupAllCharts();
            
            // 滚动到周报区域
            $('html, body').animate({
                scrollTop: $("#reports-section").offset().top - 100
            }, 500);
            
            $.ajax({
                url: '/get_report_detail/',
                type: 'GET',
                data: {
                    report_id: reportId
                },
                success: function(response) {
                    $('#report-loading').addClass('d-none');
                    
                    if (response.success) {
                        // 显示周报数据
                        displayWeeklyReport(response.report);
                        
                        // 添加返回按钮
                        if (!$('#back-to-current').length) {
                            const backBtn = $('<button id="back-to-current" class="btn btn-outline-secondary mb-3"><i class="fas fa-arrow-left me-2"></i>返回当前周报</button>');
                            backBtn.click(function() {
                                generateWeeklyReport(selectedDays);
                            });
                            $('#report-content').before(backBtn);
                        }
                    } else {
                        // 显示错误信息
                        $('#report-error').removeClass('d-none').text(response.msg || '加载周报详情失败');
                    }
                },
                error: function() {
                    $('#report-loading').addClass('d-none');
                    $('#report-error').removeClass('d-none').text('网络错误，请稍后重试');
                }
            });
        }

        // 获取Cookie值
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) {
                const cookieValue = parts.pop().split(';').shift();
                return cookieValue;
            }
            return null;
        }
    </script>
</body>
</html>